<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="keywords" content>
  <meta name="author" content="delryn">
  <meta name="description" content="나의 개발 노트 ʕ •ᴥ• ʔ">
  
  
  <title>
    
      AWS SQS 사용해보기 
      
      
    
  </title>

  
    <link rel="apple-touch-icon" href="/images/favicon.png">
    <link rel="icon" href="/images/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  
<link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="/iconfont/iconfont.css">
<link rel="stylesheet" href="/css/github-markdown.css">
<link rel="stylesheet" href="/css/highlight.css">


  <!-- jquery3.3.1 -->
  <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

  <!-- fancybox -->
  <link href="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.css" rel="stylesheet">
  <script async src="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  
<script src="/js/fancybox.js"></script>


  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-104148803-2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-104148803-2');
    </script>
  

<meta name="generator" content="Hexo 5.3.0"><link rel="alternate" href="/atom.xml" title="Delryn's Blog" type="application/atom+xml">
</head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a href="/">
      <!-- 头像取消懒加载，添加no-lazy -->
      
        <img src="/images/avatar.png" alt>
      
    </a>
    <div class="nickname"><a href="/">Delryn</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">Home</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">Archives</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">Tags</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">About</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->

<!-- LaTex Display -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
</script>
<script>
MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']]
  }
};
</script>



  

  

  

  
  <!-- 文章内容页 url形式：https://yoursite/文章标题/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">AWS SQS 사용해보기</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime" title="Update time"></i>
          2020-03-04 23:17:51
        </span>
        
              <span class="post-tags">
                <i class="iconfont icon-tags" title="Tags"></i>
                
                <span class="span--tag">
                  <a href="/tags/AWS/" title="AWS">
                    <b>#</b> AWS
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/Queue/" title="Queue">
                    <b>#</b> Queue
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <h2 id="SQS란"><a href="#SQS란" class="headerlink" title="SQS란?"></a>SQS란?</h2><p>서버들끼리 사용할 수 있는 완전관리형 Message Queue 서비스</p>
<h3 id="Message-Queue란"><a href="#Message-Queue란" class="headerlink" title="Message Queue란?"></a>Message Queue란?</h3><p>메시지를 이용하여 여러 서버를 연결해주는 역할이라 생각 한다.</p>
<p>방식은 sender가 데이터를 Queue에 적재했다가 receiver가 꺼내서 처리 한다.</p>
<h3 id="목적"><a href="#목적" class="headerlink" title="목적"></a>목적</h3><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.icelancer.com/2016/12/message-queue.html">Message Queue는 왜 사용해야 하는가?</a></p>
<h2 id="실습"><a href="#실습" class="headerlink" title="실습"></a>실습</h2><p>SQS는 표준, FIFO 두 가지를 지원 한다.</p>
<h3 id="표준"><a href="#표준" class="headerlink" title="표준"></a>표준</h3><p>express(sender)에서 SQS(Queue)에 메세지를 적재 하고 Lambda(receiver)에서</p>
<p>꺼낸 다음에 DynamoDB에 저장을 실습으로 해보겠다.</p>
<h4 id="생성"><a href="#생성" class="headerlink" title="생성"></a>생성</h4><p><img src="https://res.cloudinary.com/ddebpn43q/image/upload/v1564911596/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2019-08-04_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_3.03.26_eqtwnv.png" alt="생성"></p>
<p>표준으로 하면 메세지가 중복으로 올 수 있다는건데 어플리케이션에서 처리를 해야 할 꺼 같다.</p>
<p><img src="https://res.cloudinary.com/ddebpn43q/image/upload/v1564912059/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2019-08-04_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_6.43.43_y1gobg.png" alt="생성결과"></p>
<h4 id="sender"><a href="#sender" class="headerlink" title="sender"></a>sender</h4><p>API 호출 시 SQS에 메세지를 전송하게끔 한다.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> AWS = <span class="built_in">require</span>(<span class="string">&#x27;aws-sdk&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> PORT = process.env.PORT || <span class="number">3000</span>;</span><br><span class="line"></span><br><span class="line">app.use(bodyParser.json());</span><br><span class="line">app.use(bodyParser.urlencoded(&#123;</span><br><span class="line">  extended: <span class="literal">true</span></span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line">AWS.config.update(&#123;</span><br><span class="line">  region: <span class="string">&#x27;&#x27;</span>, <span class="comment">// 리전</span></span><br><span class="line">  accessKeyId: <span class="string">&#x27;&#x27;</span>, <span class="comment">// IAM</span></span><br><span class="line">  secretAccessKey: <span class="string">&#x27;&#x27;</span> <span class="comment">// IAM</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sqs = <span class="keyword">new</span> AWS.SQS(&#123; <span class="attr">apiVersion</span>: <span class="string">&#x27;2012-11-05&#x27;</span> &#125;);</span><br><span class="line"></span><br><span class="line">app.listen(PORT, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;server is listening&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.send(<span class="string">&#x27;hihi&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendMessage</span>(<span class="params">message</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> params = &#123;</span><br><span class="line">    QueueUrl: <span class="string">&#x27;생성한 SQS URL&#x27;</span>,</span><br><span class="line">    MessageBody: <span class="built_in">JSON</span>.stringify(message),</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    sqs.sendMessage(params).promise().then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      resolve();</span><br><span class="line">    &#125;).catch(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">      reject(e);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">&#x27;/login&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> id = req.body.id;</span><br><span class="line">  <span class="keyword">const</span> log = &#123; id, <span class="attr">dtm</span>: <span class="built_in">Date</span>.now(), <span class="attr">action</span>: <span class="string">&#x27;login&#x27;</span> &#125;;</span><br><span class="line">  sendMessage(log).then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    res.json(&#123; <span class="attr">code</span>: <span class="number">200</span>, <span class="attr">message</span>: <span class="string">&#x27;success&#x27;</span> &#125;);</span><br><span class="line">  &#125;).catch(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    res.json(&#123; <span class="attr">code</span>: <span class="number">500</span>, <span class="attr">message</span>: e &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">&#x27;/purchase&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; id, item &#125; = req.body;</span><br><span class="line">  <span class="keyword">const</span> log = &#123; id, item, <span class="attr">dtm</span>: <span class="built_in">Date</span>.now(), <span class="attr">action</span>: <span class="string">&#x27;purchase&#x27;</span> &#125;;</span><br><span class="line">  sendMessage(log).then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    res.json(&#123; <span class="attr">code</span>: <span class="number">200</span>, <span class="attr">message</span>: <span class="string">&#x27;success&#x27;</span> &#125;);</span><br><span class="line">  &#125;).catch(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> res.json(&#123; <span class="attr">code</span>: <span class="number">500</span>, <span class="attr">message</span>: e &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">&#x27;/search&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; id, word &#125; = req.body.id;</span><br><span class="line">  <span class="keyword">const</span> log = &#123; id, word, <span class="attr">dtm</span>: <span class="built_in">Date</span>.now(), <span class="attr">action</span>: <span class="string">&#x27;search&#x27;</span> &#125;;</span><br><span class="line">  sendMessage(log).then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    res.json(&#123; <span class="attr">code</span>: <span class="number">200</span>, <span class="attr">message</span>: <span class="string">&#x27;success&#x27;</span> &#125;);</span><br><span class="line">  &#125;).catch(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    res.json(&#123; <span class="attr">code</span>: <span class="number">500</span>, <span class="attr">message</span>: e &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="receiver"><a href="#receiver" class="headerlink" title="receiver"></a>receiver</h4><p>Lambda를 receiver로 쓸 껀데 해당 하는 IAM 역할을 생성을 미리 해야 한다.</p>
<h5 id="권한-생성"><a href="#권한-생성" class="headerlink" title="권한 생성"></a>권한 생성</h5><ol>
<li>역핢 만들기를 누른다.</li>
<li>사용 사례는 lambda로</li>
<li>SQS 검색해서 추가</li>
<li>로그를 보기 위해 CloudWatch도 추가</li>
<li>태그는 대충..</li>
<li>마지막으로 확인 후 생성</li>
</ol>
<p><img src="https://res.cloudinary.com/ddebpn43q/image/upload/v1564912498/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2019-08-04_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_4.38.44_lct92b.png" alt="권한 - 1"></p>
<p><img src="https://res.cloudinary.com/ddebpn43q/image/upload/v1564912540/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2019-08-04_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_4.38.56_v6dtw7.png" alt="권한 - 2"></p>
<p><img src="https://res.cloudinary.com/ddebpn43q/image/upload/v1564912589/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2019-08-04_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_4.39.09_v6vw41.png" alt="권한 - 3"></p>
<p><img src="https://res.cloudinary.com/ddebpn43q/image/upload/v1564912658/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2019-08-04_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_4.39.29_y0lhjm.png" alt="권한 - 4"></p>
<p><img src="https://res.cloudinary.com/ddebpn43q/image/upload/v1564912715/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2019-08-04_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_4.39.45_jtepdo.png" alt="권한 - 5"></p>
<p><img src="https://res.cloudinary.com/ddebpn43q/image/upload/v1564912754/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2019-08-04_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_4.40.11_rdb3ou.png" alt="권한 - 6"></p>
<h5 id="Lambda-생성"><a href="#Lambda-생성" class="headerlink" title="Lambda 생성"></a>Lambda 생성</h5><ol>
<li>위에서 만든 권한을 연결</li>
<li>코드를 작성 해서 Lambda에 업로드</li>
</ol>
<p><img src="https://res.cloudinary.com/ddebpn43q/image/upload/v1564912834/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2019-08-04_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_4.40.59_q8qvy2.png" alt="권한연결"></p>
<p><img src="https://res.cloudinary.com/ddebpn43q/image/upload/v1564912900/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2019-08-04_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_4.41.50_ichu61.png" alt="결과"></p>
<p><img src="https://res.cloudinary.com/ddebpn43q/image/upload/v1564912947/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2019-08-04_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_4.42.06_spxuby.png" alt="트리거추가"></p>
<p>아래의 코드는 대기열이 만든 메세지 ID를 기반으로 dynamodb에서 체크를 한 다음에 넣는다.</p>
<p>실무에서 안 써 봤기에 AWS 커뮤니티에 질문한 결과 이런 식으로 하는 게 맞다고 한다.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> AWS = <span class="built_in">require</span>(<span class="string">&#x27;aws-sdk&#x27;</span>);</span><br><span class="line"></span><br><span class="line">AWS.config.update(&#123;</span><br><span class="line">  region: <span class="string">&#x27;&#x27;</span>, <span class="comment">// 리전</span></span><br><span class="line">  accessKeyId: <span class="string">&#x27;&#x27;</span>, <span class="comment">// IAM</span></span><br><span class="line">  secretAccessKey: <span class="string">&#x27;&#x27;</span> <span class="comment">// IAM</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sqs = <span class="keyword">new</span> AWS.SQS(&#123; <span class="attr">apiVersion</span>: <span class="string">&#x27;2012-11-05&#x27;</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> dynamo = <span class="keyword">new</span> AWS.DynamoDB.DocumentClient();</span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.handler = <span class="keyword">async</span> (event) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * body: 내가 보낸 메세지</span></span><br><span class="line"><span class="comment">   * messageId: unique인진 모르겠지만 메세지 아디가 존재</span></span><br><span class="line"><span class="comment">   * receiptHandle: 메세지를 큐에서 지우기 위한 파라미터</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">const</span> &#123; body, messageId, receiptHandle &#125; = event.Records[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> message = <span class="built_in">JSON</span>.parse(body);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> haveData;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> params = &#123;</span><br><span class="line">      TableName: <span class="string">&#x27;테이블명&#x27;</span>,</span><br><span class="line">      Key: &#123;</span><br><span class="line">        messageId: messageId,</span><br><span class="line">        dtm: <span class="built_in">Number</span>(message.dtm),</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    haveData = <span class="keyword">await</span> dynamo.get(params).promise();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;sqs worker err&#x27;</span>, e);</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">statusCode</span>: <span class="number">500</span>, <span class="attr">message</span>: <span class="string">&#x27;sqs worker err&#x27;</span> &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> haveData !== <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> putParams = &#123;</span><br><span class="line">        TableName: <span class="string">&#x27;테이블명&#x27;</span>,</span><br><span class="line">        Item: &#123;</span><br><span class="line">          messageId: messageId,</span><br><span class="line">          dtm: <span class="built_in">Number</span>(message.dtm),</span><br><span class="line">          action: message.action</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="keyword">if</span> (message.action === <span class="string">&#x27;purchase&#x27;</span>) params.Item.item = message.item;</span><br><span class="line">      <span class="keyword">if</span> (message.action === <span class="string">&#x27;search&#x27;</span>) params.Item.search = message.word;</span><br><span class="line">      <span class="keyword">const</span> removeParams = &#123; <span class="attr">QueueUrl</span>: <span class="string">&#x27;SQS URL&#x27;</span>, ReceiptHandle &#125;;</span><br><span class="line">      <span class="keyword">await</span> <span class="built_in">Promise</span>.all([</span><br><span class="line">        dynamo.put(putParams).promise(),</span><br><span class="line">        sqs.deleteMessage(removeParams).promise(),</span><br><span class="line">      ]);</span><br><span class="line">      <span class="keyword">return</span> &#123; <span class="attr">statusCode</span>: <span class="number">200</span>, <span class="attr">message</span>: <span class="string">&#x27;sqs worker success&#x27;</span> &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;sqs worker err&#x27;</span>, e);</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">statusCode</span>: <span class="number">500</span>, <span class="attr">message</span>: <span class="string">&#x27;sqs worker err&#x27;</span> &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="테스트"><a href="#테스트" class="headerlink" title="테스트"></a>테스트</h4><p>코드를 실행 하기 전에 DynamoDB를 생성 한다.</p>
<p><img src="https://res.cloudinary.com/ddebpn43q/image/upload/v1564913031/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2019-08-04_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_5.44.24_r35cg0.png" alt="dynamodb"></p>
<p>요청 결과는 다음과 같다.</p>
<p><img src="https://res.cloudinary.com/ddebpn43q/image/upload/v1564913314/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2019-08-04_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_7.08.22_nhela2.png" alt="request"></p>
<p><img src="https://res.cloudinary.com/ddebpn43q/image/upload/v1564913351/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2019-08-04_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_6.17.38_il4lgl.png" alt="response"></p>
<h3 id="FIFO"><a href="#FIFO" class="headerlink" title="FIFO"></a>FIFO</h3><h4 id="sqs-생성"><a href="#sqs-생성" class="headerlink" title="sqs 생성"></a>sqs 생성</h4><p>fifo 방식은 대기열 이름 뒤에 .fifo를 붙여야 한다.</p>
<p><img src="https://res.cloudinary.com/dwmywmqv6/image/upload/v1586187582/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2020-04-06_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_11.55.41_ymmkdq.png" alt="SQS 생성"></p>
<p>아래에 대기열 생성 파랑 버튼 클릭</p>
<p><img src="https://res.cloudinary.com/dwmywmqv6/image/upload/v1586188170/eqweqwe_ynydaf.png" alt="SQS 생성 완료"></p>
<p>생성 완료 시 아래의 URL은 나중에 필요.</p>
<h4 id="sender-1"><a href="#sender-1" class="headerlink" title="sender"></a>sender</h4><p>로컬에서 테스트를 해 본다.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> AWS = <span class="built_in">require</span>(<span class="string">&#x27;aws-sdk&#x27;</span>);</span><br><span class="line"></span><br><span class="line">AWS.config.update(&#123;</span><br><span class="line">  region: <span class="string">&#x27;&#x27;</span>, <span class="comment">// 리전</span></span><br><span class="line">  accessKeyId: <span class="string">&#x27;&#x27;</span>, <span class="comment">// IAM</span></span><br><span class="line">  secretAccessKey: <span class="string">&#x27;&#x27;</span> <span class="comment">// IAM</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sqs = <span class="keyword">new</span> AWS.SQS(&#123; <span class="attr">apiVersion</span>: <span class="string">&#x27;2012-11-05&#x27;</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> randomStr = <span class="function">(<span class="params">len</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> result = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="keyword">const</span> characters = <span class="string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789&#x27;</span>;</span><br><span class="line">  <span class="keyword">const</span> charactersLength = characters.length;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">    result += characters.charAt(<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * charactersLength));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sendMessage = <span class="function">(<span class="params">type, id, body</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> params = &#123;</span><br><span class="line">    QueueUrl: <span class="string">&#x27;SQS에서 발급한 URL&#x27;</span>,</span><br><span class="line">    MessageBody: <span class="built_in">JSON</span>.stringify(body), <span class="comment">// <span class="doctag">NOTE:</span> 보낼 메세지</span></span><br><span class="line">    MessageGroupId: type, <span class="comment">// <span class="doctag">NOTE:</span> 메시지 그룹 ID 특정 메시지 그룹에 속한 메시지를 지정하는 태그. 동일한 메시지 그룹에 속한 메시지는 메시지 그룹에 따라 엄격한 순서로 항상 하나씩 처리됩니다</span></span><br><span class="line">    MessageDeduplicationId: <span class="string">`<span class="subst">$&#123;id&#125;</span>:<span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>().getTime()&#125;</span>:<span class="subst">$&#123;randomStr(<span class="number">5</span>)&#125;</span>`</span>, <span class="comment">// <span class="doctag">NOTE:</span> 메시지 중복 제거 ID 전송된 메시지의 중복 제거에 사용되는 토큰. 특정 메시지 중복 제거 ID가 있는 메시지를 성공적으로 전송한 경우, 메시지 중복 제거 ID가 동일한 모든 메시지는 성공적으로 수신되지만 중복 제거 간격인 5분 동안은 전달되지 않습니다.</span></span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> result = sqs.sendMessage(params).promise();</span><br><span class="line">    result.then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;성공한 메세지&#x27;</span>, <span class="built_in">JSON</span>.stringify((data)));</span><br><span class="line">      resolve(data);</span><br><span class="line">    &#125;).catch(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;실패한 메세지&#x27;</span>, <span class="built_in">JSON</span>.stringify(params));</span><br><span class="line">      reject(e);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">sendMessage(<span class="string">&#x27;join&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, &#123;<span class="attr">id</span>: <span class="string">&#x27;a&#x27;</span>, <span class="attr">ts</span>: <span class="keyword">new</span> <span class="built_in">Date</span>().getTime(), <span class="attr">message</span>: <span class="string">&#x27;hihi&#x27;</span>&#125;).then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;a - send success&#x27;</span>);</span><br><span class="line">&#125;).catch(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;e&#x27;</span>, e);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  sendMessage(<span class="string">&#x27;join&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, &#123;<span class="attr">id</span>: <span class="string">&#x27;b&#x27;</span>, <span class="attr">ts</span>: <span class="keyword">new</span> <span class="built_in">Date</span>().getTime(), <span class="attr">message</span>: <span class="string">&#x27;hello&#x27;</span>&#125;).then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;b - send success&#x27;</span>);</span><br><span class="line">  &#125;).catch(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;e&#x27;</span>, e);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;, <span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  sendMessage(<span class="string">&#x27;join&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, &#123;<span class="attr">id</span>: <span class="string">&#x27;c&#x27;</span>, <span class="attr">ts</span>: <span class="keyword">new</span> <span class="built_in">Date</span>().getTime(), <span class="attr">message</span>: <span class="string">&#x27;나비보벳따우&#x27;</span>&#125;).then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;c - send success&#x27;</span>);</span><br><span class="line">  &#125;).catch(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;e&#x27;</span>, e);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;, <span class="number">500</span>);</span><br></pre></td></tr></table></figure>
<p>전송 순서는 a -&gt; c -&gt; b다.</p>
<h4 id="receiver-1"><a href="#receiver-1" class="headerlink" title="receiver"></a>receiver</h4><h5 id="권한-생성-1"><a href="#권한-생성-1" class="headerlink" title="권한 생성"></a>권한 생성</h5><p>위에서 만든 표준 SQS 역할과 같다.</p>
<p><img src="https://res.cloudinary.com/dwmywmqv6/image/upload/v1586188248/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2020-04-07_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_12.03.26_j5igud.png" alt="IAM 생성"></p>
<h5 id="Lambda-생성-1"><a href="#Lambda-생성-1" class="headerlink" title="Lambda 생성"></a>Lambda 생성</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> AWS = <span class="built_in">require</span>(<span class="string">&#x27;aws-sdk&#x27;</span>);</span><br><span class="line"></span><br><span class="line">AWS.config.update(&#123;</span><br><span class="line">  region: <span class="string">&#x27;&#x27;</span>, <span class="comment">// 리전</span></span><br><span class="line">  accessKeyId: <span class="string">&#x27;&#x27;</span>, <span class="comment">// IAM</span></span><br><span class="line">  secretAccessKey: <span class="string">&#x27;&#x27;</span> <span class="comment">// IAM</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ddb = <span class="keyword">new</span> AWS.DynamoDB.DocumentClient(&#123; <span class="attr">apiVersion</span>: <span class="string">&#x27;2012-08-10&#x27;</span> &#125;);</span><br><span class="line"><span class="keyword">const</span> sqs = <span class="keyword">new</span> AWS.SQS(&#123; <span class="attr">apiVersion</span>: <span class="string">&#x27;2012-11-05&#x27;</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.handler = <span class="keyword">async</span> (event) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> body = <span class="built_in">JSON</span>.parse(event.Records[<span class="number">0</span>].body);</span><br><span class="line">  <span class="keyword">const</span> receiptHandle = event.Records[<span class="number">0</span>].receiptHandle;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;body&#x27;</span>, body);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;receiptHandle&#x27;</span>, receiptHandle);</span><br><span class="line">  <span class="keyword">const</span> putParams = &#123;</span><br><span class="line">    TableName: <span class="string">&#x27;receive&#x27;</span>,</span><br><span class="line">    Item: &#123;</span><br><span class="line">      id: body.id,</span><br><span class="line">      timestamp: body.ts,</span><br><span class="line">      message: body.message,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">const</span> sqsParams = &#123;</span><br><span class="line">    QueueUrl: <span class="string">&#x27;SQS에서 발급하는 URL&#x27;</span>,</span><br><span class="line">    ReceiptHandle: receiptHandle, <span class="comment">// <span class="doctag">NOTE:</span> 해당 메세지의 UUID라 생각하면 될듯.</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="built_in">Promise</span>.all([</span><br><span class="line">      ddb.put(putParams).promise(), <span class="comment">// <span class="doctag">NOTE:</span> dynamodb에 저장</span></span><br><span class="line">      sqs.deleteMessage(sqsParams).promise(), <span class="comment">// <span class="doctag">NOTE:</span> 수신한 메세지는 삭제</span></span><br><span class="line">    ]);</span><br><span class="line">    <span class="keyword">const</span> response = &#123;</span><br><span class="line">      statusCode: <span class="number">200</span>,</span><br><span class="line">      body: <span class="built_in">JSON</span>.stringify(<span class="string">&#x27;receive success&#x27;</span>),</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;e&#x27;</span>, e);</span><br><span class="line">    <span class="keyword">const</span> response = &#123;</span><br><span class="line">      statusCode: <span class="number">500</span>,</span><br><span class="line">      body: <span class="built_in">JSON</span>.stringify(<span class="string">&#x27;receive err&#x27;</span>),</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h5 id="Lambda-트리거-설정"><a href="#Lambda-트리거-설정" class="headerlink" title="Lambda 트리거 설정"></a>Lambda 트리거 설정</h5><p><img src="https://res.cloudinary.com/dwmywmqv6/image/upload/v1586188519/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2020-04-07_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_12.16.55_hvzumg.png" alt="lambda 트리거 설정"></p>
<h5 id="테스트-1"><a href="#테스트-1" class="headerlink" title="테스트"></a>테스트</h5><p><img src="https://res.cloudinary.com/dwmywmqv6/image/upload/v1586188696/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2020-04-07_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_12.56.55_ntkiob.png" alt="cloudwatch 결과"></p>
<p><img src="https://res.cloudinary.com/dwmywmqv6/image/upload/v1586188637/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2020-04-07_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_12.56.35_hamng2.png" alt="dynamodb 결과"></p>
<p>허용되는 범위의 메세지의 수로 테스트를 해봐야 정확하나 우선은 의도한대로 프로세스는 작동 했다.</p>
<h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://sarc.io/index.php/miscellaneous/1615-message-queue-mq">Message Queue (MQ) 란 무엇일까</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.aws.amazon.com/ko_kr/sdk-for-javascript/v2/developer-guide/sqs-examples-send-receive-messages.html">Amazon SQS Node.js 예제</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.aws.amazon.com/ko_kr/AWSSimpleQueueService/latest/SQSDeveloperGuide/using-messagegroupid-property.html">Amazon SQS 메시지 그룹 ID 사용</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.aws.amazon.com/ko_kr/AWSSimpleQueueService/latest/SQSDeveloperGuide/using-messagededuplicationid-property.html">Amazon SQS 메시지 중복 제거 ID 사용</a></li>
</ul>

      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/2020/01/12/nodejs-express-swagger/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>Prev</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime" title="Update time"></i>
              2020-03-04 23:17:51
            </span>
            
                  <span class="post-tags">
                    <i class="iconfont icon-tags" title="Tags"></i>
                    
                    <span class="span--tag">
                      <a href="/tags/AWS/" title="AWS">
                        <b>#</b> AWS
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/Queue/" title="Queue">
                        <b>#</b> Queue
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
              <a href="/2020/04/12/nodejs-morgan-winston-example/" target="_self">
                <span>Next</span>
                <i class="iconfont icon-chevronright"></i>
              </a>
            
          </div>
        </div>
      
    </div>
    
  <div class="post-catalog" id="catalog">
    <div class="title">Contents</div>
    <div class="catalog-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#SQS%EB%9E%80"><span class="toc-text">SQS란?</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Message-Queue%EB%9E%80"><span class="toc-text">Message Queue란?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EB%AA%A9%EC%A0%81"><span class="toc-text">목적</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EC%8B%A4%EC%8A%B5"><span class="toc-text">실습</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%ED%91%9C%EC%A4%80"><span class="toc-text">표준</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%EC%83%9D%EC%84%B1"><span class="toc-text">생성</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sender"><span class="toc-text">sender</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#receiver"><span class="toc-text">receiver</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%EA%B6%8C%ED%95%9C-%EC%83%9D%EC%84%B1"><span class="toc-text">권한 생성</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Lambda-%EC%83%9D%EC%84%B1"><span class="toc-text">Lambda 생성</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%ED%85%8C%EC%8A%A4%ED%8A%B8"><span class="toc-text">테스트</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FIFO"><span class="toc-text">FIFO</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#sqs-%EC%83%9D%EC%84%B1"><span class="toc-text">sqs 생성</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sender-1"><span class="toc-text">sender</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#receiver-1"><span class="toc-text">receiver</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%EA%B6%8C%ED%95%9C-%EC%83%9D%EC%84%B1-1"><span class="toc-text">권한 생성</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Lambda-%EC%83%9D%EC%84%B1-1"><span class="toc-text">Lambda 생성</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Lambda-%ED%8A%B8%EB%A6%AC%EA%B1%B0-%EC%84%A4%EC%A0%95"><span class="toc-text">Lambda 트리거 설정</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%ED%85%8C%EC%8A%A4%ED%8A%B8-1"><span class="toc-text">테스트</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EC%B0%B8%EA%B3%A0"><span class="toc-text">참고</span></a></li></ol>
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
      <div class="comments-container">
        






  <script src="https://utteranc.es/client.js" repo="hidelryn/blog-comment" issue-term="title" label="Comment" theme="github-light" crossorigin="anonymous" async>
    </script>
  

      </div>
    
  </div>


        <div class="footer">
  <div class="social">
    <ul>
      
        <li>
          <a title="github" target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/hidelryn/">
            <i class="iconfont icon-github"></i>
          </a>
        </li>
      
        <li>
          <a title="email" href="mailto:hidelryn@gmail.com" rel="external nofollow noopener noreferrer" target="_blank">
            <i class="iconfont icon-envelope"></i>
          </a>
        </li>
      
        <li>
          <a title="rss" href="/atom.xml">
            <i class="iconfont icon-rss"></i>
          </a>
        </li>
      
    </ul>
  </div>
  
  
    <div class="footer-more">
      
        <span style="color: #666;">Copyright © Delryn 2023</span>
        
        
    </div>
  
    <div class="footer-more">
      
        <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/zchengsite/hexo-theme-oranges">Theme by Oranges | Powered by Hexo</a>
        
    </div>
  
</div>

      </div>

      <div class="back-to-top hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



      
  <div class="search-icon" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="Search...">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>First search, index file loading, please wait...<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>No result<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The search.xml file was not found, please refer to：<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The request failed, Try to refresh the page or try again later.<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




    </div>
  </body>
</html>
